---

# FK Integrity Checker

Инструмент для проверки ссылочной целостности в PostgreSQL на основе внешних связей, заданных в YAML-файле. Не требует наличия объявленных `FOREIGN KEY` в схеме базы данных. Предназначен для валидации данных после миграций, загрузок или ETL-процессов.

## Требования

- Python 3.7+
- Библиотеки: `psycopg2`, `pyyaml`

Установка зависимостей:
```bash
pip install psycopg2 pyyaml
```

## Конфигурация

### 1. Файл правил: `fk_rules.yaml`

Содержит список проверок в виде массива объектов. Каждый объект описывает связь между дочерней и родительской таблицами:

```yaml
rules:
  - child_table: orders
    child_col: customer_id
    parent_table: customers
    parent_col: customer_id

  - child_table: order_details
    child_col: product_id
    parent_table: products
    parent_col: product_id

  # ... остальные правила
```

Поддерживаются самоссылки (например, `employees.reports_to → employees.employee_id`). Значения `NULL` в дочерней колонке игнорируются.

### 2. Подключение к БД

В скрипте `check_fk_integrity.py` задайте параметры подключения:

```python
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'northwind',
    'user': 'postgres',
    'password': 'your_password'
}
```

Рекомендуется вынести чувствительные данные в переменные окружения или использовать `.pgpass`.

## Использование

Запуск:
```bash
python3 check_fk_integrity.py
```

Скрипт выполняет следующие действия:
1. Читает правила из `fk_rules.yaml`.
2. Для каждой связи формирует SQL-запрос, находящий значения в дочерней таблице, отсутствующие в родительской.
3. Выводит результаты в консоль.
4. При обнаружении нарушений завершается с кодом выхода `1`.

Пример вывода при нарушении:
```
Проверяю: orders.ship_via → shippers.shipper_id
   НАРУШЕНО: 830 записей
     Примеры: [1, 2, 3]
```

При отсутствии нарушений:
```
✅ Все проверки пройдены. Целостность соблюдена.
```

## Пример данных: Northwind

Для тестирования можно использовать образ Northwind для PostgreSQL:

```bash
git clone https://github.com/pthom/northwind_psql.git
cd northwind_psql
docker-compose up -d
```

База данных будет доступна на `localhost:5432` с учётными данными по умолчанию:
- БД: `northwind`
- Пользователь: `postgres`
- Пароль: `postgres`

## Особенности реализации

- Проверка выполняется через `LEFT JOIN ... WHERE parent_key IS NULL`.
- Учитываются только ненулевые значения в дочерней колонке.
- Возвращается до 10 примеров нарушенных значений для диагностики.
- Подходит для автоматизации в CI/CD или cron-задачах.

## Ограничения

- Предполагается, что типы данных в связанных колонках совместимы.
- Не проверяются составные внешние ключи.
- Производительность зависит от наличия индексов по проверяемым колонкам.

--- 

Этот инструмент не заменяет декларативные ограничения СУБД, но предоставляет способ верифицировать логическую целостность данных в средах, где такие ограничения отсутствуют или не могут быть применены.
